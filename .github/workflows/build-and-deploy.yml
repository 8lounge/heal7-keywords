name: HEAL7 Keywords Build and Deploy

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
    inputs:
      build_environment:
        description: 'Build Environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
          - development

env:
  NODE_ENV: production
  # í™˜ê²½ë³€ìˆ˜ëŠ” GitHub Secretsì—ì„œ ìë™ ì£¼ì…
  DATABASE_URL: ${{ secrets.DATABASE_URL }}
  GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
  JWT_SECRET: ${{ secrets.JWT_SECRET }}
  ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}

jobs:
  build-frontend:
    runs-on: ubuntu-latest
    name: Build Next.js Keywords Frontend
    
    strategy:
      matrix:
        node-version: [18, 20]
        
    outputs:
      build-status: ${{ steps.build-check.outputs.status }}
      build-time: ${{ steps.build-check.outputs.time }}
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: ğŸ“¦ Install dependencies
      run: |
        cd frontend
        npm ci --prefer-offline --no-audit --legacy-peer-deps --include=dev
        
    - name: ğŸ” Type check
      run: |
        cd frontend
        npm run type-check || echo "Type check not available"
        
    - name: ğŸ—ï¸ Build Next.js Keywords Application
      id: build-step
      run: |
        cd frontend
        echo "ğŸš€ Starting keywords build process..."
        npm run build
        echo "âœ… Keywords build completed successfully!"
      env:
        NODE_OPTIONS: '--max-old-space-size=4096'
        NEXT_TELEMETRY_DISABLED: 1
        
    - name: ğŸ“Š Build statistics
      id: build-check
      run: |
        cd frontend
        BUILD_TIME=$(date '+%Y-%m-%d %H:%M:%S')
        echo "time=$BUILD_TIME" >> $GITHUB_OUTPUT
        echo "status=success" >> $GITHUB_OUTPUT
        
        if [ -d ".next" ]; then
          NEXT_SIZE=$(du -sh .next | cut -f1)
          echo "ğŸ“ .next directory size: $NEXT_SIZE"
        fi
        
        if [ -d "out" ]; then
          OUT_SIZE=$(du -sh out | cut -f1)
          echo "ğŸ“ out directory size: $OUT_SIZE"
        fi
        
    - name: ğŸ“¦ Create build artifact
      run: |
        cd frontend
        BUILD_TIMESTAMP=$(date +%Y%m%d-%H%M%S)
        ARTIFACT_NAME="heal7-keywords-build-node${{ matrix.node-version }}-${BUILD_TIMESTAMP}"
        
        # .next ë””ë ‰í† ë¦¬ê°€ ìˆìœ¼ë©´ í¬í•¨
        TAR_FILES=""
        if [ -d ".next" ]; then
          TAR_FILES="$TAR_FILES .next/"
        fi
        
        # out ë””ë ‰í† ë¦¬ê°€ ìˆìœ¼ë©´ í¬í•¨
        if [ -d "out" ]; then
          TAR_FILES="$TAR_FILES out/"
        fi
        
        # public ë””ë ‰í† ë¦¬ í¬í•¨
        if [ -d "public" ]; then
          TAR_FILES="$TAR_FILES public/"
        fi
        
        # package.jsonê³¼ next.config.js í¬í•¨
        TAR_FILES="$TAR_FILES package.json next.config.js"
        
        echo "ğŸ“¦ Creating keywords artifact with: $TAR_FILES"
        tar -czf "${ARTIFACT_NAME}.tar.gz" $TAR_FILES
        
        echo "ARTIFACT_NAME=${ARTIFACT_NAME}" >> $GITHUB_ENV
        
    - name: â¬†ï¸ Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: heal7-keywords-build-node${{ matrix.node-version }}
        path: frontend/${{ env.ARTIFACT_NAME }}.tar.gz
        retention-days: 7
        compression-level: 9

  build-backend:
    runs-on: ubuntu-latest
    name: Test Python Keywords Backend
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: ğŸ“¦ Install Python dependencies
      run: |
        cd backend
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        else
          echo "âš ï¸ requirements.txt not found, skipping dependency installation"
        fi
        
    - name: ğŸ§ª Run Python syntax check
      run: |
        cd backend
        python -m py_compile main.py keywords_api.py
        echo "âœ… Python syntax check passed"

  deploy-notification:
    needs: [build-frontend, build-backend]
    runs-on: ubuntu-latest
    name: Keywords Build Complete Notification
    if: always()
    
    steps:
    - name: ğŸ“Š Keywords Build Summary
      run: |
        echo "ğŸ‰ HEAL7 Keywords Build Summary"
        echo "================================"
        echo "Frontend Build Status: ${{ needs.build-frontend.result }}"
        echo "Backend Test Status: ${{ needs.build-backend.result }}"
        echo "Build Time: ${{ needs.build-frontend.outputs.build-time }}"
        echo ""
        if [ "${{ needs.build-frontend.result }}" == "success" ]; then
          echo "âœ… í‚¤ì›Œë“œ í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ì„±ê³µ!"
          echo "ğŸ“¥ ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ ì¤€ë¹„ ì™„ë£Œ"
          echo ""
          echo "ğŸ”½ ë‹¤ìŒ ë‹¨ê³„:"
          echo "1. ë¡œì»¬ì—ì„œ ë‹¤ìš´ë¡œë“œ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰"
          echo "   ./download-keywords-artifacts.sh"
          echo "2. ë¹Œë“œ ê²°ê³¼ë¬¼ì„ í”„ë¡œë•ì…˜ í™˜ê²½ì— ë°°í¬"
          echo "3. í‚¤ì›Œë“œ ì„œë¹„ìŠ¤ ì¬ì‹œì‘"
        else
          echo "âŒ ë¹Œë“œ ì‹¤íŒ¨ - ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”"
        fi
        echo ""
        echo "ğŸ”— GitHub Actions: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        
    - name: ğŸš€ Keywords Deployment Instructions
      if: needs.build-frontend.result == 'success'
      run: |
        echo "ğŸ“ í‚¤ì›Œë“œ ë°°í¬ ê°€ì´ë“œ:"
        echo ""
        echo "# 1. ë¹Œë“œ ê²°ê³¼ë¬¼ ë‹¤ìš´ë¡œë“œ"
        echo "cd /home/ubuntu/project/heal7-keywords"
        echo "gh run download --name heal7-keywords-build-node20"
        echo ""
        echo "# 2. ì„œë¹„ìŠ¤ ì¤‘ì§€"
        echo "sudo systemctl stop nginx"
        echo ""
        echo "# 3. ë¹Œë“œ íŒŒì¼ êµì²´"
        echo "tar -xzf heal7-keywords-build-*.tar.gz"
        echo "cp -r out/* /var/www/heal7-keywords/ || cp -r .next /home/ubuntu/project/heal7-keywords/frontend/"
        echo ""
        echo "# 4. í‚¤ì›Œë“œ ì„œë¹„ìŠ¤ ì‹œì‘"
        echo "cd /home/ubuntu/project/heal7-keywords/backend && python main.py &"
        echo "sudo systemctl start nginx"