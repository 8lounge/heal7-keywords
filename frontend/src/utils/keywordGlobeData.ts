import * as THREE from 'three'

export interface KeywordNode {
  id: string
  name: string
  category: string
  subcategory: string
  weight: number
  connections: number
  position: [number, number, number]
  color: string
  dependencies: string[]
}

// 카테고리별 색상 매핑
const categoryColors = {
  'A-1': '#3B82F6', // 인지차원 - 파랑
  'A-2': '#06B6D4', // 개방성차원 - 청록
  'A-3': '#10B981', // 에너지차원 - 초록
  'A-4': '#8B5CF6', // 관계차원 - 보라
  'A-5': '#F59E0B', // 정서차원 - 주황
  'B-1': '#EF4444', // 전전두엽계 - 빨강
  'B-2': '#EC4899', // 측두두정계 - 핑크
  'B-3': '#6366F1', // 변경계 - 인디고
  'B-4': '#84CC16', // 기저핵계 - 라임
  'B-5': '#F97316', // 뇌간계 - 오렌지
  'B-6': '#14B8A6', // 신경화학계 - 틸
  'C-1': '#DC2626', // 불안스트레스 - 진한 빨강
  'C-2': '#7C2D12', // 우울무기력 - 갈색
  'C-3': '#991B1B', // 분노공격성 - 진한 빨강
  'C-4': '#7C2D12', // 중독의존 - 갈색
  'C-5': '#BE123C', // 사회부적응 - 로즈
  'C-6': '#A21CAF', // 강박완벽주의 - 자주
  'C-7': '#581C87', // 자기파괴 - 진한 보라
  'C-8': '#1E1B4B', // 인지왜곡 - 진한 남색
  'C-9': '#450A0A'  // 성격장애 - 진한 갈색
}

// 구체 표면에 균등하게 점들을 분산시키는 함수 (Golden Spiral)
export function generateSpherePoints(count: number, radius: number = 2): [number, number, number][] {
  const points: [number, number, number][] = []
  const phi = Math.PI * (3 - Math.sqrt(5)) // Golden angle

  for (let i = 0; i < count; i++) {
    const y = 1 - (i / (count - 1)) * 2 // y goes from 1 to -1
    const radiusAtY = Math.sqrt(1 - y * y) * radius
    const theta = phi * i

    const x = Math.cos(theta) * radiusAtY
    const z = Math.sin(theta) * radiusAtY
    
    points.push([x, y * radius, z])
  }

  return points
}

// 실제 442개 키워드 데이터 생성
export function generateKeywordNodes(): KeywordNode[] {
  const keywordData = [
    // A그룹 (심리학적) - 176개
    // A-1 (인지차원) - 44개
    { group: 'A-1', names: ['창의성', '논리적사고', '직관력', '집중력', '기억력', '학습능력', '문제해결력', '분석력', '종합력', '추상적사고', '구체적사고', '비판적사고', '유연한사고', '체계적사고', '독창성', '상상력', '통찰력', '판단력', '의사결정력', '계획수립력', '목표설정력', '우선순위설정', '시간관리', '정보처리력', '패턴인식', '공간지각력', '언어능력', '수리능력', '예술적감각', '미적감각', '음악적재능', '운동지능', '신체조절력', '손재주', '세밀함', '정확성', '완벽추구', '꼼꼼함', '주의깊음', '관찰력', '호기심', '탐구심', '실험정신', '도전정신'] },
    
    // A-2 (개방성차원) - 29개  
    { group: 'A-2', names: ['개방성', '호기심', '새로운경험추구', '변화수용', '다양성인정', '포용력', '관용', '유연성', '적응력', '학습욕구', '지적호기심', '예술적관심', '문화적관심', '철학적사고', '종교적관심', '영성추구', '초월적경험', '직관적통찰', '상상력', '환상', '꿈', '비전', '이상추구', '미래지향', '진보성', '혁신성', '창조성', '독창성', '개성추구'] },
    
    // A-3 (에너지차원) - 27개
    { group: 'A-3', names: ['활력', '에너지', '활동성', '적극성', '추진력', '행동력', '실행력', '의욕', '열정', '열심', '성실', '근면', '부지런함', '끈기', '인내', '지구력', '체력', '건강', '생명력', '활기', '명랑함', '쾌활함', '긍정성', '낙관성', '희망', '용기', '담대함'] },
    
    // A-4 (관계차원) - 45개
    { group: 'A-4', names: ['사회성', '외향성', '친화력', '대인관계', '소통능력', '표현력', '경청능력', '공감력', '이해력', '배려', '친절', '다정함', '온화함', '부드러움', '상냥함', '예의바름', '정중함', '존중', '신뢰', '믿음직함', '진실함', '정직', '성실함', '약속이행', '책임감', '의무감', '협력', '팀워크', '화합', '조화', '중재능력', '갈등해결', '리더십', '지도력', '영향력', '설득력', '협상력', '네트워킹', '사교성', '인기', '매력', '카리스마', '유머감각', '재치', '즐거움'] },
    
    // A-5 (정서차원) - 31개
    { group: 'A-5', names: ['정서지능', '감정조절', '자기조절', '충동조절', '인내력', '참을성', '절제력', '자제력', '평정심', '냉정함', '침착함', '안정감', '평온함', '고요함', '여유', '느긋함', '만족감', '행복감', '기쁨', '즐거움', '웃음', '유쾌함', '쾌감', '감사', '고마움', '사랑', '애정', '정', '따뜻함', '온정', '자비'] },

    // B그룹 (신경과학적) - 127개  
    // B-1 (전전두엽계) - 11개
    { group: 'B-1', names: ['실행기능', '작업기억', '인지유연성', '억제조절', '주의집중', '계획수립', '목표지향', '의사결정', '문제해결', '추상적사고', '메타인지'] },
    
    // B-2 (측두두정계) - 14개
    { group: 'B-2', names: ['공간인지', '시각처리', '청각처리', '감각통합', '신체인식', '주의배분', '다중처리', '패턴인식', '얼굴인식', '사회인지', '마음이론', '관점수용', '공감반응', '거울뉴런'] },
    
    // B-3 (변연계) - 44개
    { group: 'B-3', names: ['감정처리', '기억형성', '학습동기', '보상처리', '두려움', '불안', '스트레스반응', '투쟁도피', '애착형성', '사회유대', '신뢰형성', '공감', '동정', '연민', '사랑', '애정', '성적욕구', '모성본능', '보호본능', '영역본능', '경쟁심', '질투', '분노', '적대감', '공격성', '복수심', '원한', '미움', '혐오', '역겨움', '수치심', '죄책감', '후회', '슬픔', '우울', '절망', '외로움', '그리움', '향수', '기쁨', '행복', '희망', '감사', '만족'] },
    
    // B-4 (기저핵계) - 13개
    { group: 'B-4', names: ['운동조절', '습관형성', '자동처리', '절차학습', '기술습득', '반복학습', '근육기억', '운동기억', '행동패턴', '루틴형성', '강화학습', '보상학습', '중독성향'] },
    
    // B-5 (뇌간계) - 22개
    { group: 'B-5', names: ['각성수준', '의식상태', '수면패턴', '생체리듬', '호흡조절', '심박조절', '혈압조절', '체온조절', '식욕조절', '갈증조절', '성욕조절', '생존본능', '위험감지', '반사반응', '자동반응', '무의식반응', '본능반응', '원시반응', '생리반응', '신체반응', '감정반응', '스트레스반응'] },
    
    // B-6 (신경화학계) - 23개
    { group: 'B-6', names: ['도파민활성', '세로토닌균형', '노르에피네프린', '아세틸콜린', '가바균형', '엔도르핀분비', '옥시토신분비', '코르티솔조절', '신경전달', '시냅스가소성', '뉴런연결', '신경발달', '신경재생', '신경보호', '항산화', '염증조절', '면역조절', '호르몬균형', '대사조절', '에너지대사', '영양흡수', '독소배출', '세포재생'] },

    // C그룹 (개선영역) - 139개
    // C-1 (불안스트레스) - 19개
    { group: 'C-1', names: ['일반불안', '사회불안', '분리불안', '공황불안', '광장공포증', '특정공포증', '강박불안', '외상스트레스', '급성스트레스', '만성스트레스', '업무스트레스', '인간관계스트레스', '경제스트레스', '건강스트레스', '시간압박', '성과압박', '완벽압박', '사회압박', '기대압박'] },
    
    // C-2 (우울무기력) - 16개  
    { group: 'C-2', names: ['주요우울', '경미우울', '계절우울', '산후우울', '노년우울', '청소년우울', '무기력', '의욕상실', '흥미상실', '에너지저하', '피로감', '절망감', '무가치감', '자책감', '죄책감', '자살사고'] },
    
    // C-3 (분노공격성) - 15개
    { group: 'C-3', names: ['폭발적분노', '만성분노', '억압된분노', '간헐적분노', '언어적공격', '신체적공격', '관계적공격', '자기공격', '타인공격', '물건파괴', '동물학대', '복수행동', '보복심리', '적대감', '증오심'] },
    
    // C-4 (중독의존) - 9개
    { group: 'C-4', names: ['알코올중독', '약물중독', '게임중독', '인터넷중독', '도박중독', '쇼핑중독', '음식중독', '성중독', '관계중독'] },
    
    // C-5 (사회부적응) - 14개
    { group: 'C-5', names: ['사회공포', '대인기피', '고립성향', '회피성향', '소외감', '외로움', '사회기술부족', '의사소통장애', '갈등회피', '갈등증폭', '권위거부', '규칙거부', '사회규범위반', '반사회성향'] },
    
    // C-6 (강박완벽주의) - 12개
    { group: 'C-6', names: ['강박사고', '강박행동', '완벽주의', '세부집착', '순서집착', '청결강박', '확인강박', '수집강박', '대칭강박', '반복강박', '의식강박', '도덕강박'] },
    
    // C-7 (자기파괴) - 9개
    { group: 'C-7', names: ['자해행동', '자살시도', '자기비하', '자기처벌', '자기방해', '기회박탈', '관계파괴', '성취방해', '미래박탈'] },
    
    // C-8 (인지왜곡) - 22개
    { group: 'C-8', names: ['전부아니면전무', '과잉일반화', '정신적여과', '긍정적할인', '성급한결론', '확대축소', '감정적추론', '당위적사고', '개인화', '비교왜곡', '운명론적사고', '파국적사고', '흑백논리', '선입견', '고정관념', '인지편향', '확증편향', '생존편향', '가용성편향', '대표성편향', '기준점편향', '손실회피편향'] },
    
    // C-9 (성격장애) - 23개
    { group: 'C-9', names: ['편집성성격', '분열성성격', '분열형성격', '반사회성성격', '경계성성격', '연기성성격', '자기애성성격', '회피성성격', '의존성성격', '강박성성격', '수동공격성', '자기중심성', '조작성향', '착취성향', '과시성향', '허영심', '우월감', '열등감', '불안정애착', '회피애착', '무질서애착', '애착손상', '신뢰손상'] }
  ]

  const keywords: KeywordNode[] = []
  const positions = generateSpherePoints(442, 2.2)
  let positionIndex = 0

  keywordData.forEach(({ group, names }) => {
    names.forEach((name, index) => {
      const id = `${group}-${index}`
      const weight = Math.random() * 8 + 2 // 2-10 사이의 가중치
      const connections = Math.floor(Math.random() * 25) + 5 // 5-30 사이의 연결 수
      
      // 의존성 관계 무작위 생성 (같은 그룹 내 높은 확률, 다른 그룹과도 일부 연결)
      const dependencies: string[] = []
      const sameGroupKeywords = names.filter(n => n !== name).slice(0, 3)
      sameGroupKeywords.forEach(otherName => {
        if (Math.random() > 0.7) {
          const otherIndex = names.indexOf(otherName)
          dependencies.push(`${group}-${otherIndex}`)
        }
      })

      keywords.push({
        id,
        name,
        category: group,
        subcategory: group.startsWith('A') ? '심리학적' : group.startsWith('B') ? '신경과학적' : '개선영역',
        weight,
        connections,
        position: positions[positionIndex],
        color: categoryColors[group as keyof typeof categoryColors] || '#888888',
        dependencies
      })

      positionIndex++
    })
  })

  return keywords
}

// 키워드 검색 및 필터링 유틸리티
export function searchKeywords(keywords: KeywordNode[], query: string): KeywordNode[] {
  if (!query.trim()) return keywords
  
  const lowerQuery = query.toLowerCase()
  return keywords.filter(keyword => 
    keyword.name.toLowerCase().includes(lowerQuery) ||
    keyword.category.toLowerCase().includes(lowerQuery) ||
    keyword.subcategory.toLowerCase().includes(lowerQuery)
  )
}

export function filterKeywordsByCategory(keywords: KeywordNode[], category: string): KeywordNode[] {
  if (category === 'all') return keywords
  return keywords.filter(keyword => keyword.category.startsWith(category))
}